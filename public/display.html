<html>
    <head>
        <!-- Load Bootstrap/CSS/Popper/Jquery/Socket.io -->
        <link rel="stylesheet" href="/css/gamestyle.css"> </link>
        <link rel="stylesheet" href="/css/bootstrap.min.css"> </link>
        <link rel="stylesheet" href="/css/display.css"> </link>
        <script src="/js/jquery-3.6.0.min.js"></script>
        <script src="/js/popper.min.js" ></script>
        <script src="/js/bootstrap.min.js" ></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="/js/ClientObj.js"></script>

        <title>Guessing Game!</title>
    </head>

    <body>
        <nav class="navbar navbar-expand-lg sticky-top navbar-light bg-light">
            <!-- <ul class="navbar-nav ml-0"> -->
                
              <!-- <li class="nav-item"> -->
                <!-- <div class="dropdown show"> -->
                    <!-- <a class="btn btn-secondary dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> -->
                        <!-- Game Menu
                    </a> -->
                  
                    <!-- <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                        <button class="btn btn-primary" id="restartButton">Restart Game</button>
                        <div class="dropdown-divider"></div>
                        <button class="btn btn-info" id="refreshButton">Refresh Game </button>
                        <div class="dropdown-divider"></div>
                        <a class="btn btn-danger" href="index.html">Back To Game</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">Current Game Params:</a> -->
            <p class="navbar-text ml-auto pb-0" id="range"></p>
            <p class="navbar-text ml-auto pb-0" id="shareSize"></p>
            <p class="navbar-text ml-auto pb-0" id="winNum"></p>
                        <!--<div class="dropdown-divider"></div>
                        <input type="text" placeholder="Range,Share Size..." id="myInput">
                        <button class="btn btn-warning" id="paramButton" >Set Game Params </button>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" id="arduinostatus"></a>
                        <div class="dropdown-divider"></div>
                        <button class="btn btn-info" id="startArduinoButton">Start Arduino </button>
        
                    </div> -->
                <!-- </div> -->
            <!-- </ul> -->
            <!-- <a class="navbar-brand" href="#">Guessing Game!</a> -->

            <p class="navbar-text ml-auto pb-0" id="server-time"></p>
        </nav>

        <div id="panel" class="container-fluid"></div>
          
    </body>

   

    <script>
        //References;
        // link for grid https://stackoverflow.com/questions/43115822/can-i-make-a-css-grid-with-dynamic-number-of-rows-or-columns
        //link for rese https://stackoverflow.com/questions/61155301/how-to-remove-divs-inside-a-grid
        //https://stackoverflow.com/questions/64859592/how-can-i-make-div-content-appear-with-animation-when-clicking-a-button-that-inj
        
        const fadeDuration = 200;
        const fadeWait = 500;
        const COLORS = ['#FE9','#9AF','#F9A',"#AFA","#FA7"];
        const container = $('#panel');
        var isGameOver = false;
        var clientDict = new Map();
        var range = -1;
        var shareSize = -1;
        

        function resetGrid(){
            document.querySelectorAll(".item").forEach((e) => e.parentNode.removeChild(e));
        }
 

        function removeBlocks() {
            document.querySelectorAll(".animate").forEach((e) => e.remove(e));
            document.querySelectorAll(".block").forEach((e) => e.remove(e));
        }
        
        // Add new client div to the display panel
        function addClientToPanel(id, myC){
            //create name div
            var clientName = document.createElement("div");
            clientName.innerHTML = myC.name;
            clientName.setAttribute('id', "client_name");
            clientName.className = "client_name";
            //create num div
            var clientNum = document.createElement("div");
            clientNum.innerHTML = parseInt(myC.num);
            clientNum.setAttribute('id', "num");
            //create div to hold everything
            var block = document.createElement("div");
            block.appendChild(clientName);
            block.appendChild(clientNum);
            block.setAttribute('id', id); //set id of div to be the client id
            block.className = "block";

            //set div color
            block.style.background = myC.color;

            container.append(block); //add to panel   
        }

        /*Updates client div in display panel*/
        function updateClient(id,obj){
            //get client div from container
            var client = document.getElementById(id);
            var clientNum = client.lastElementChild;
            clientNum.innerHTML = parseInt(obj.num); //update its current value
            console.log("animating " + obj.name);

            client.style.zIndex = 100; //send to the front
            client.classList.add("animate"); //add animation
            
            setTimeout(function() {
                client.classList.remove("animate");
            }, 2500); // 500 is the same time as the CSS animation
            void client.offsetWidth;
            client.style.zIndex = 0;

            let box = client;
            let width = box.clientWidth;
            let height = box.clientHeight;
            console.log("THIS IS THE WIDTH " + width);
            console.log("THIS IS THE HEIGHT " + height);
            
        }


        // Removes client from display panel
        function removeClient(id){
            let client = document.getElementById(id);
            client.remove();
        }

        // update block when winner found
        function updateWinnerBlock(id) {
            var winningClient;
            if(isGameOver){
                for(let [key,value] of clientDict){
                    if(key === id){
                        winningClient = document.getElementById(id);
                        winningClient.style.background = "#2ECC71";
                        winningClient.classList.add('winnerAnimate');
                    }
                    else {
                        var client = document.getElementById(key);
                        client.style.background = "#E74C3C";
                        client.classList.remove('animate');
                    }
                }
            }

            winningClient.classList.remove("winnerAnimate");
        }


        // Updates game parameters
        function updateParams(params){
            range = params[0];
            document.getElementById('range').innerHTML = "Range: " + range;
            shareSize = params[1];
            document.getElementById('shareSize').innerHTML = "Share size: " + shareSize;
            winNum = params[2];
            document.getElementById('winNum').innerHTML = "Winning Number: " + winNum;
        }


        function handleGameEnd(winner){
            isGameOver = true;
            updateWinnerBlock(winner);
        }


        function handleRestart(newStatus, newParams){
            //reset div color upon restart
            for (let [key,value] of clientDict){
                document.getElementById(key).style.backgroundColor = value.color;
            }
            winningId = "";
            updateParams(newParams);
            isGameOver = newStatus;
        }


        function handleGameStart(startMsg){
            //reset panel
            resetGrid();
            removeBlocks();
            updateParams(startMsg.parameters); //for display parameters

            //set up client map
            clientDict = new Map(Object.entries(startMsg.map)); // cast back to map
            for(const [key,value] of clientDict.entries()){
                addClientToPanel(key,value); //add each client to the board
            }
        }

        // ------------------------ sockets --------------------------
        // URL defaults to window.location
        let socket = io('/display.html');
        let currentShare = [];
        let currentPos = -1;
        let winningNum = -1;
        let winningId = "";

        // registers display panel in game and checks if game is finished
        socket.on('displayRegistered', (msg) => {
            // HERE msg = {map: clientMapping, parameters: params, gameStatus: gameOver, winner: winningClient}
            console.log("registered display panel...");
            handleGameStart(msg);

            if(msg.gameStatus){ //if the game is over, put in proper format
                handleGameEnd(msg.winner);
            }
        });


        // Handle the case of restarting the game
        socket.on('displayRestartGame', (msg) => {
            console.log("Restarting the display");
            handleRestart(msg.gameStatus, msg.pamameters);
        });


        socket.on('displayGotAWinner', (winner) => {
            console.log('got a winner -- display');
            handleGameEnd(winner);
        });


        //adds client to window and dictionary
        socket.on('displayNewClient', (msg) => {
            console.log('added client to screen...');
            clientDict = new Map(Object.entries(msg.map)); // update clientDict to be the new mapping
            let lastElem = clientDict.get(msg.id);          
            addClientToPanel(msg.id, lastElem); //1 is a ClientObj
        });


        //cilnet number has changed, checks map for changes and updates
        socket.on('displayNumberSwitch', (msg)  => {
            if (!clientDict.has(msg.id)){ // id not in client dict
                console.log('Houston we have a problem');
                return;
            }
            updateClient(msg.id, msg.newClient);
        });


        // update the paramters upon receive
        socket.on('displayUpdateParams', (msg) => {
            updateParams(msg);
        });


        //removes client from panel and dictionary
        socket.on('displayremoveClient', (msg) => {
            console.log('Client disconnected, removing from game');
            clientDict = new Map(Object.entries(msg.map));
            removeClient(msg.id);
        });
    

        socket.on('time', (timeString) => {
            let elem = document.getElementById('server-time');
            elem.innerHTML = 'Server time: ' + timeString;
        });


    </script>
</html>
