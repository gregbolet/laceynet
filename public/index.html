<html>
  <head>
    <!-- Load Bootstrap/CSS/Popper/Jquery/Socket.io -->
    <link rel="stylesheet" href="/css/gamestyle.css"> </link>
    <link rel="stylesheet" href="/css/bootstrap.min.css"> </link>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/popper.min.js" ></script>
    <script src="/js/bootstrap.min.js" ></script>
    <script src="/socket.io/socket.io.js"></script>

    <title>Guessing Game!</title>
  </head>

  <body>

    <nav class="navbar navbar-expand-lg sticky-top navbar-light bg-light">
      <ul class="navbar-nav ml-0">
        <li class="nav-item">
          <!-- <button class="btn btn-primary" id="quitButton">Quit</button> -->
          <button class="btn btn-primary" id="quitButton">Quit</button>
          <a class="btn btn-warning" href="display.html">Display Panel</a>
        </li>
        
      </ul>
      <!--<a class="navbar-brand mx-auto" href="#" id="playerName">Player: </a>-->
      <p class="navbar-text ml-auto pb-0" id="server-time"></p>
    </nav>

<div class="clientName" id="playerName"> Player:... </div>

    <div class="container col-md-12 align-middle">

      <div id="redXOverlay"> 
        <img class="overlayimg" src="/svg/redX.svg" />
      </div>
      <div id="greenCheckOverlay"> 
        <img class="overlayimg" src="/svg/greenCheck.svg" />
      </div>
      <button id="mainbutton" type="button" class="btn btn-primary btn-block mainbuttonstyle">
        Waiting for restart signal...
      </button>

    </div>

  </body>

  <script>
    // Use JQuery to grab our button object
    var button = $( "#mainbutton" );
    var quitBtn = $( "#quitButton" );
    var imageDict = {
      "Ben Franklin": "images/benfrank-removebg-preview.png", 
      "Ada Lovelace": "images/adalovelace.jpg", 
      "Muhammad Ali":"images/ali-removebg-preview.png", 
      "Harriet Tubman": "images/harriettubman.png", 
      "Frank Sinatra": "images/franksinatra.jfif", 
      "Grace Hopper": "images/gracehopper.png",
      "Louis Armstrong": "images/louis.png"
    };

    const fadeDuration = 200;
    const fadeWait = 500;
    var gameEnded = true;
    console.log("disabled main button");
    document.getElementById('mainbutton').disabled = true; // disable main btn
    //false when io is sent

    function setContinueMode(){
      if(!isGameOver){
        button.removeClass( "btn-danger" )
        button.removeClass( "btn-warning" );
        button.removeClass( "btn-success" )
        button.addClass( "btn-primary" );
      }
      console.log("Continue mode is called " + new Date().toTimeString());
    }

    function setRestartMode(){
      if(!isGameOver){
        button.removeClass( "btn-danger" )
        button.removeClass( "btn-primary" )
        button.removeClass( "btn-success" )
        button.addClass( "btn-warning" )
      }
    }

    function setLoserMode(){
      if(!isGameOver){
        button.removeClass( "btn-warning" )
        button.removeClass( "btn-primary" )
        button.removeClass( "btn-success" )
        button.addClass( "btn-danger" )
        gameEnded = true;
        //button.html('Winner found! Waiting for restart...');
        isGameOver = true;
        console.log("IS the game over? "  + isGameOver + new Date().toTimeString());
      }
    }

    function setWinnerMode(){
      if(!isGameOver){
        button.removeClass( "btn-danger" )
        button.removeClass( "btn-warning" )
        button.removeClass( "btn-primary" )
        button.addClass( "btn-success" )
      }
    }

    function showOverlayRedX(callback){
      console.log("red overlay is being called");
      $("#redXOverlay").fadeIn(fadeDuration).delay(fadeWait).fadeOut(fadeDuration, callback); 
    }

    function showOverlayGreenCheck(callback){
      $("#greenCheckOverlay").fadeIn(fadeDuration).delay(fadeWait).fadeOut(fadeDuration, callback); 
    }


    // quit button - close window, disconnect client, update display
    quitBtn.click(function(){
      window.close('','_parent',''); // close window
      socket.emit('disconnect');
    });


    button.click(function(){
      // Do nothing if the game is over
      if(isGameOver){
        console.log("sorry game over oop");
        return;
      }
      // If we click on the winning number, let the server know
      // Otherwise, advance to the next number in the share
      if(currentPos < currentShare.length && winningNum == currentShare[currentPos]){
        console.log(`I think I\'m a winner! ${winningNum}, [${currentShare}]`);
        socket.emit('iAmAWinner', {share:currentShare, id:socket.id});
      }
      // If we have over-clicked, let's request new work
      // and let the server know we completed our share
      else if(currentPos >= currentShare.length - 1){
        console.log(`Completed share! ${currentShare}`);
        showOverlayRedX(function(){
          socket.emit('completedShare', {share:currentShare});
        });
      }  
      else{
        showOverlayRedX(function(){
          socket.emit('buttonPressed', {currNum: currentShare[currentPos], id:socket.id});  
        });
        setContinueMode();
        currentPos++;
        console.log("Curr pos is " + currentPos);
        console.log("Curr num is " + currentShare[currentPos]);
        button.html(`${currentShare[currentPos]}`); 
      }

    }); 


    // ------------------------ sockets --------------------------
    // URL defaults to window.location
    var socket = io('/');
    var currentShare = [];
    var currentPos = -1;
    var winningNum = -1;
    var isGameOver = false;
    var playerName = "";


    socket.on('clientStartGame', (msg) => {
      document.getElementById('mainbutton').disabled = false; // enable main btn
      gameEnded = msg;
      // button.prop('disabled', false); // enable main btn
    });

    // Handle the message where we are confirmed to have registered
    socket.on('registered', (msg) => {
      isGameOver = msg.gameStatus;
      playerName = msg.name;
      document.getElementById('playerName').innerHTML = "Player: " + playerName;
      var img = document.createElement("img");
      img.className ="picture";
      if (Object.keys(imageDict).includes(msg.name)){
        img.setAttribute("src",imageDict[msg.name]);
        document.getElementById('playerName').appendChild(img);
      }
      if(msg.start){
        document.getElementById('mainbutton').disabled = false;
      }
      
      
    });

    // Handle incoming message for the requested share
    socket.on('newShare', (msg) => {
      if(isGameOver){
        console.log("sorry the game is over");
        return;
      }

      console.log('Got a new share');
      console.log(msg.share);
      currentShare = msg.share;
      winningNum = msg.winNum;
      currentPos = 0;

      // Set the button text to the first element
      button.html(`${currentShare[currentPos]}`);   
      setContinueMode();
    });

    // On share acceptance, request a new share of work
    socket.on('shareAccepted', (msg) => {
      socket.emit('needNewShare'); 
    });

    // On share rejection, request a new share of work
    socket.on('shareRejected', (msg) => {
      socket.emit('needNewShare'); 
    });

    // Handle the case where we have a winner 
    socket.on('weGotAWinner', (msg) => {
      setLoserMode();
      button.html('Winner found! Waiting for restart...');
      console.log("im a loser :(" + new Date().toTimeString());
    });

    // Handle the case where we are told we lost 
    socket.on('youDidNotWin', (msg) => {
      socket.emit('needNewShare'); 
    });

    // Handle the case where we ARE the winner 
    socket.on('youAreTheWinner', (msg) => {
      setWinnerMode();
      isGameOver = true;
      showOverlayGreenCheck();
    });

    // Handle the case of restarting the game
    socket.on('restartGame', (msg) => {
      setLoserMode();
      isGameOver = false;
      socket.emit('needNewShare');
    });

    socket.on('updateWinningNumber', (msg) => {
      winningNum = msg;
      console.log('the new wining number is ' + winningNum);
    })

    // Handle the case where we are told to idle
    socket.on('idle', (msg) => {
      setLoserMode();
      isGameOver = true;
    });

    socket.on('time', (timeString) => {
      let el = document.getElementById('server-time');
      el.innerHTML = 'Server time: ' + timeString;
    });
    
  </script>

</html>
