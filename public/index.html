<html>
  <head>
    <!-- Load Bootstrap/CSS/Popper/Jquery/Socket.io -->
    <link rel="stylesheet" href="bootstrap.min.css"> </link>
    <script src="jquery-3.6.0.min.js"></script>
    <script src="popper.min.js" ></script>
    <script src="bootstrap.min.js" ></script>
    <script src="/socket.io/socket.io.js"></script>

    <title>Guessing Game!</title>

    <style>
      .navbar-nav {
        margin-left: auto;
      }
    </style>
  </head>


  <body>

    <nav class="navbar navbar-expand-lg sticky-top navbar-light bg-light">
      <ul class="navbar-nav ml-0">
        <li class="nav-item">
          <button class="btn btn-primary" id="restartButton">Restart Game</button>
          <a class="btn btn-warning" href="adminPanel">Admin Panel</a>
        </li>
      </ul>
        <p class="navbar-text ml-auto pb-0" style="padding-bottom:0px ! important;" id="server-time"></p>
    </nav>


    <div class="container" style="width:100%; height:100%;">
      <div class="col-md-12 text-center align-middle" style="width:100%; height:100%;">
        <button id="mainbutton" type="button" class="btn btn-primary btn-block" style="font-size:500%; width:100%; height:100%; height:50%; position: absolute; top:25%;">
          Connecting to game server...
        </button>
      </div>
    </div>

  </body>

  <script>

    // Use JQuery to grab our button object
    var button = $( "#mainbutton" );
    var restartBtn = $( "#restartButton" );

    function setContinueMode(){
          button.removeClass( "btn-danger" )
          button.removeClass( "btn-warning" );
          button.removeClass( "btn-success" )
          button.addClass( "btn-primary" );
        }

    function setRestartMode(){
          button.removeClass( "btn-danger" )
          button.removeClass( "btn-primary" )
          button.removeClass( "btn-success" )
          button.addClass( "btn-warning" )
        }

    function setLoserMode(){
          button.removeClass( "btn-warning" )
          button.removeClass( "btn-primary" )
          button.removeClass( "btn-success" )
          button.addClass( "btn-danger" )
        }

    function setWinnerMode(){
          button.removeClass( "btn-danger" )
          button.removeClass( "btn-warning" )
          button.removeClass( "btn-primary" )
          button.addClass( "btn-success" )
        }

    // URL defaults to window.location
    let socket = io();
    let el;
    let currentShare = [];
    let currentPos = -1;
    let winningNum = -1;

    restartBtn.click(function(){
      socket.emit('restartGame', {share:currentShare});
    });

    // Setup the logic for when the button is pressed
    button.click(function(){
          // If we have over-clicked, let's request new work
          // and let the server know we completed our share
          if(currentPos >= currentShare.length - 1){
                socket.emit('completedShare', {share:currentShare});
              }  
          // If we click on the winning number, let the server know
          else if(winningNum == currentShare[currentPos]){
                console.log('I think I\'m a winner!');
                socket.emit('iAmAWinner', {share:currentShare});
              }
          // Otherwise, advance to the next number in the share
          else{
                setContinueMode();
                currentPos++;
                button.html(`${currentShare[currentPos]}`);   
              }
        });

    socket.on('time', (timeString) => {
          el = document.getElementById('server-time');
          el.innerHTML = 'Server time: ' + timeString;
        });

    // Handle the message where we are confirmed to have registered
    socket.on('registered', (msg) => {
          console.log('Requesitng a new share');
          socket.emit('needNewShare');
        });

    // Handle incoming message for the requested share
    socket.on('newShare', (msg) => {
          console.log('Got a new share');
          currentShare = msg.share;
          winningNum = msg.winNum;
          currentPos = 0;

          // Set the button text to the first element
          button.html(`${currentShare[currentPos]}`);   
          setContinueMode();

        });

    // On share acceptance, request a new share of work
    socket.on('shareAccepted', (msg) => {
          socket.emit('needNewShare'); 
        });

    // On share rejection, request a new share of work
    socket.on('shareRejected', (msg) => {
          socket.emit('needNewShare'); 
        });

    // Handle the case where we have a winner 
    socket.on('weGotAWinner', (msg) => {
          setLoserMode();
        });

    // Handle the case where we are told to idle
    socket.on('idle', (msg) => {
          setLoserMode();
        });

    // Handle the case where we are told we lost 
    socket.on('youDidNotWin', (msg) => {
          socket.emit('needNewShare'); 
        });

    // Handle the case where we ARE the winner 
    socket.on('youAreTheWinner', (msg) => {
          setWinnerMode();
        });

    // Handle the case of restarting the game
    socket.on('restartGame', (msg) => {
          setLoserMode();
          socket.emit('needNewShare');
        });
  </script>

</html>
