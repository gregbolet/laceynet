<html>
  <head>
    <!-- Load Bootstrap/CSS/Popper/Jquery/Socket.io -->
    <link rel="stylesheet" href="/css/gamestyle.css"> </link>
    <link rel="stylesheet" href="/css/bootstrap.min.css"> </link>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/popper.min.js" ></script>
    <script src="/js/bootstrap.min.js" ></script>
    <script src="/socket.io/socket.io.js"></script>

    <title>Guessing Game!</title>
  </head>


  <body>

    <nav class="navbar navbar-expand-lg sticky-top navbar-light bg-light">
      <ul class="navbar-nav ml-0">
        <li class="nav-item">
          <button class="btn btn-primary" id="restartButton">Restart Game</button>
          <a class="btn btn-warning" href="admin.html">Admin Panel</a>
        </li>
      </ul>
      <p class="navbar-text ml-auto pb-0" id="server-time"></p>
    </nav>

    <div class="container col-md-12 align-middle">
      <div id="redXOverlay"> 
        <img class="overlayimg" src="/svg/redX.svg" />
      </div>
      <div id="greenCheckOverlay"> 
        <img class="overlayimg" src="/svg/greenCheck.svg" />
      </div>
      <button id="mainbutton" type="button" class="btn btn-primary btn-block mainbuttonstyle">
        Waiting for restart signal...
      </button>

    </div>



  </body>

  <script>

    // Use JQuery to grab our button object
    var button = $( "#mainbutton" );
    var restartBtn = $( "#restartButton" );
    let isGameOver = false;

    function setContinueMode(){
          if(!isGameOver){
                button.removeClass( "btn-danger" )
                button.removeClass( "btn-warning" );
                button.removeClass( "btn-success" )
                button.addClass( "btn-primary" );
              }
        }

    function setRestartMode(){
          if(!isGameOver){
                button.removeClass( "btn-danger" )
                button.removeClass( "btn-primary" )
                button.removeClass( "btn-success" )
                button.addClass( "btn-warning" )
              }
        }

    function setLoserMode(){
          if(!isGameOver){
                button.removeClass( "btn-warning" )
                button.removeClass( "btn-primary" )
                button.removeClass( "btn-success" )
                button.addClass( "btn-danger" )

                isGameOver = true;
              }
        }

    function setWinnerMode(){
          if(!isGameOver){
                button.removeClass( "btn-danger" )
                button.removeClass( "btn-warning" )
                button.removeClass( "btn-primary" )
                button.addClass( "btn-success" )
              }
        }

    const fadeDuration = 200;
    const fadeWait = 500;

    function showOverlayRedX(callback){
         $("#redXOverlay").fadeIn(fadeDuration).delay(fadeWait).fadeOut(fadeDuration, callback); 
    }

    function showOverlayGreenCheck(callback){
         $("#greenCheckOverlay").fadeIn(fadeDuration).delay(fadeWait).fadeOut(fadeDuration, callback); 
    }

    // URL defaults to window.location
    let socket = io();
    let el;
    let currentShare = [];
    let currentPos = -1;
    let winningNum = -1;

    restartBtn.click(function(){
          socket.emit('restartGame', {share:currentShare});
        });

    // Setup the logic for when the button is pressed
    button.click(function(){

          // Do nothing if the game is over
          if(isGameOver){
                return;
              }

          // If we click on the winning number, let the server know
          // Otherwise, advance to the next number in the share
          if(currentPos < currentShare.length && winningNum == currentShare[currentPos]){
                console.log(`I think I\'m a winner! ${winningNum}, [${currentShare}]`);
                socket.emit('iAmAWinner', {share:currentShare});
              }
          // If we have over-clicked, let's request new work
          // and let the server know we completed our share
          else if(currentPos >= currentShare.length - 1){
                console.log(`Completed share! ${currentShare}`);
                showOverlayRedX(function(){
                    socket.emit('completedShare', {share:currentShare});
                });
              }  
          else{
                setContinueMode();
                showOverlayRedX(function(){
                  currentPos++;
                  button.html(`${currentShare[currentPos]}`);   
                    });
              }
        });

    socket.on('time', (timeString) => {
          el = document.getElementById('server-time');
          el.innerHTML = 'Server time: ' + timeString;
        });

    // Handle the message where we are confirmed to have registered
    socket.on('registered', (msg) => {
          console.log('Requesitng a new share');
          socket.emit('needNewShare');
        });

    // Handle incoming message for the requested share
    socket.on('newShare', (msg) => {

          if(isGameOver){
                return;
              }

          console.log('Got a new share');
          currentShare = msg.share;
          winningNum = msg.winNum;
          currentPos = 0;

          // Set the button text to the first element
          button.html(`${currentShare[currentPos]}`);   
          setContinueMode();

        });

    // On share acceptance, request a new share of work
    socket.on('shareAccepted', (msg) => {
          socket.emit('needNewShare'); 
        });

    // On share rejection, request a new share of work
    socket.on('shareRejected', (msg) => {
          socket.emit('needNewShare'); 
        });

    // Handle the case where we have a winner 
    socket.on('weGotAWinner', (msg) => {
          setLoserMode();
          button.html('Winner found! Waiting for restart...');
        });

    // Handle the case where we are told to idle
    socket.on('idle', (msg) => {
          setLoserMode();
          isGameOver = true;
        });

    // Handle the case where we are told we lost 
    socket.on('youDidNotWin', (msg) => {
          socket.emit('needNewShare'); 
        });

    // Handle the case where we ARE the winner 
    socket.on('youAreTheWinner', (msg) => {
          setWinnerMode();
          isGameOver = true;
          showOverlayGreenCheck();
        });

    // Handle the case of restarting the game
    socket.on('restartGame', (msg) => {
          setLoserMode();
          isGameOver = false;
          socket.emit('needNewShare');
        });
  </script>

</html>
